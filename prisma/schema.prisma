generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String  @id @unique

  email                  String  @unique
  username               String  @unique

  avatar                 String?

  updated                DateTime @updatedAt
  created                DateTime @default(now())

  auth_session           Session[]
  key                    Key[]

  article_movements      scm_article_movements[]
  
  attached_projects      pr_project_attached_user[]

  orders                 scm_order[]
  order_state_changes    scm_order_state_change[]

  fabrication_orders_asked            scm_fabrication_order[] @relation("fabrication_order_asked")
  fabrication_orders_received         scm_fabrication_order[] @relation("fabrication_order_received")
  fabrication_orders_state_changes    scm_fabrication_oder_state_change[]

}

model UserInvitation {

  id                     String  @id @unique @default(uuid())
  email                  String  @unique

  created                DateTime @default(now())
  
}

model Session {
  id        String  @id @unique
  user_id   String  
  active_expires BigInt
  idle_expires  BigInt
  user User @relation(references: [id], fields: [user_id], onDelete: Cascade)
}

model Key {
  id              String  @id @unique
  hashed_password String?
  user_id         String
  user            User    @relation(references: [id], fields: [user_id], onDelete: Cascade)

  @@index([user_id])
}

model AppSettings {
  key             String  @id @unique
  value           String
}

model scm_article {
  id                String   @id @default(uuid()) @unique

  name              String?
  brand             String?
  reference         String?

  order_quantity    Float @default(0)
  critical_quantity Int @default(0)

  consumable        Boolean @default(false)
  non_physical      Boolean @default(false)
  internal          Boolean @default(false)

  unit              String?
  unit_quantity     Int?

  thumbnail         String?

  acticle_movements           scm_article_movements[]
  store_relations             scm_store_relation[]
  order_rows                  scm_order_rows[]

  article_assembly_relations  scm_assembly_relation_article[]

  files                       scm_article_file[]

  fabrication_orders          scm_fabrication_order[]

}

model scm_article_file {
  id                String @id @default(uuid()) @unique

  article_id        String
  article           scm_article @relation(references: [id], fields: [article_id], onDelete: Cascade)

  file              String
}

model scm_supplier {
  id            String @id @default(uuid()) @unique
  
  name          String
  internal      Boolean @default(false)
  logo          String?

  email         String?
  phone         String?
  website       String?

  address       String?

  payment_rule  String?

  orders        scm_order[]

}

model scm_article_movements {
  id                  String  @id @default(uuid()) @unique

  article_id          String
  article             scm_article @relation(references: [id], fields: [article_id], onDelete: Cascade)

  created             DateTime  @default(now())
  quantity_update     Float  @default(0)

  user_id             String
  user User           @relation(references: [id], fields: [user_id], onDelete: Cascade)

  store_in_id         String?
  store_in            scm_store? @relation("store_out", references: [id], fields: [store_in_id], onDelete: Cascade)

  store_out_id        String?
  store_out           scm_store? @relation("store_in", references: [id], fields: [store_out_id], onDelete: Cascade)
}

model scm_store {
  id                  String @id @default(uuid()) @unique
  location            String @default("")
  name                String @default("")
  updated             String @default("")
  temporary           Boolean @default(false)

  store_in_article_movements    scm_article_movements[] @relation("store_in")
  store_out_article_movements   scm_article_movements[] @relation("store_out")

  store_relations               scm_store_relation[]
}

model scm_store_relation {

  article_id      String
  article         scm_article @relation(references: [id], fields: [article_id], onDelete: Cascade)

  quantity        Float @default(0)

  store_id        String
  store           scm_store @relation(references: [id], fields: [store_id], onDelete: Cascade)

  @@id([article_id, store_id]) // unique index based on article_id and store_id

}

model scm_assembly {
  id             String  @id @default(uuid()) @unique

  name           String
  description    String?
  assembly_time  Float @default(0)
  thumbnail      String?

  created        DateTime   @default(now())
  updated        DateTime   @updatedAt

  buylists       scm_assembly_buylist[]

  article_childrens     scm_assembly_relation_article[] @relation("assembly_relation_parent_of_articles")
  assembly_childrens    scm_assembly_relation_sub_assembly[] @relation("assembly_relation_parent_of_subassembly")

  parent_assemblies     scm_assembly_relation_sub_assembly[] @relation("assembly_relation_children_subassembly")
}

model scm_assembly_relation_sub_assembly {

  id                  String  @id @default(uuid()) @unique

  parent_id           String
  parent              scm_assembly @relation("assembly_relation_parent_of_subassembly", references: [id], fields: [parent_id], onDelete: Cascade)

  assembly_child_id   String
  assembly_child      scm_assembly @relation("assembly_relation_children_subassembly", references: [id], fields: [assembly_child_id], onDelete: Cascade)

  created             DateTime @default(now())
  quantity            Float @default(0)
  updated             DateTime @updatedAt 
  order               Int @default(0)
}

model scm_assembly_relation_article {

  id                  String  @id @default(uuid()) @unique

  parent_id           String
  parent              scm_assembly @relation("assembly_relation_parent_of_articles", references: [id], fields: [parent_id], onDelete: Cascade)

  article_child_id    String
  article_child       scm_article @relation(references: [id], fields: [article_child_id], onDelete: Cascade)

  created             DateTime @default(now())
  quantity            Float @default(0)
  updated             DateTime @updatedAt 
  order               Int @default(0)
}

model scm_assembly_buylist {

  id            String  @id @default(uuid()) @unique
  name          String  @default("")

  assembly_id   String  @default("")
  assembly      scm_assembly @relation(references: [id], fields: [assembly_id], onDelete: Cascade)

  project_id    String?  @default("")
  project       pr_project? @relation(references: [id], fields: [project_id], onDelete: Cascade)
  
  store_id      String  @default("")

  created       DateTime   @default(now())
  closed        Boolean @default(false)

}

model scm_order {

  id                  String   @id @default(uuid()) @unique
  sub_id              String   @unique

  created             DateTime @default(now())
  updated             DateTime @updatedAt

  issuer_id           String
  issuer              User @relation(references: [id], fields: [issuer_id], onDelete: Cascade)

  supplier_id         String
  supplier            scm_supplier @relation(references: [id], fields: [supplier_id], onDelete: Cascade)

  state               scm_order_state @default(draft)
  name                String

  vat                 Float @default(0)
  delivery_fees       Float @default(0)

  order_rows          scm_order_rows[]
  state_changes       scm_order_state_change[]
}

model scm_order_state_change {

  id                    String @id @default(uuid()) @unique

  order_id              String
  order                 scm_order @relation(references: [id], fields: [order_id], onDelete: Cascade)

  state                 scm_order_state
  comment               String?
  date                  DateTime @default(now())
  
  user_id               String @default("")
  user                  User @relation(references: [id], fields: [user_id], onDelete: Cascade)

}

enum scm_order_state {
  draft
  quotation
  sent
  acknowledged
  completed
  cancelled
}

model scm_order_rows {

  id                  String   @id @default(uuid()) @unique

  created             DateTime @default(now()) 
  updated             DateTime @updatedAt

  order_id            String
  order               scm_order @relation(references: [id], fields: [order_id], onDelete: Cascade)
  
  project_id          String?
  project             pr_project? @relation(references: [id], fields: [project_id], onDelete: Cascade)

  article_id          String
  article             scm_article @relation(references: [id], fields: [article_id], onDelete: Cascade)

  needed_date         DateTime?
  needed_quantity     Float  @default(0)

  ack_date            DateTime?
  ack_price           Float?  @default(0)

  received_quantity   Float  @default(0)
}

model scm_fabrication_order {

  id                  String @id @default(uuid()) @unique

  askedBy_id          String
  askedBy             User @relation("fabrication_order_asked", references: [id], fields: [askedBy_id], onDelete: Cascade)
  
  receiver_id         String?
  receiver            User? @relation("fabrication_order_received", references: [id], fields: [receiver_id], onDelete: Cascade)

  article_id          String
  article             scm_article @relation(references: [id], fields: [article_id], onDelete: Cascade)

  project_id          String?
  project             pr_project? @relation(references: [id], fields: [project_id], onDelete: Cascade)

  quantity            Float @default(1)
  state               scm_fabrication_order_state @default(draft)

  start_date          DateTime?
  end_date            DateTime?

  created             DateTime @default(now())
  updated             DateTime @updatedAt

  state_changes       scm_fabrication_oder_state_change[]

}

model scm_fabrication_oder_state_change {

  id                    String @id @default(uuid()) @unique

  fabrication_order_id  String
  fabrication_order     scm_fabrication_order @relation(references: [id], fields: [fabrication_order_id], onDelete: Cascade)

  state                 scm_fabrication_order_state
  comment               String?
  date                  DateTime @default(now())
  
  user_id               String @default("")
  user                  User @relation(references: [id], fields: [user_id], onDelete: Cascade)

}

enum scm_fabrication_order_state {
  draft
  sent
  acknowledged
  completed
  cancelled
}

model crm_company {

  id      String  @id @default(uuid()) @unique

  name    String
  size    crm_company_size
  
  country String?
  sector  String?
  type    String?
  
  created DateTime @default(now())
  updated DateTime @updatedAt

  contacts crm_company_contact[]
  leads crm_leads[]

}

enum crm_company_size {

  tiny
  small
  medium
  big
  large
  huge

}

model crm_company_contact {

  id           String  @id @default(uuid()) @unique
  
  name         String
  position     String?
  address      String?
  phone        String?
  email        String?
  spoken_langs String[]

  company_id   String
  company      crm_company @relation(references: [id], fields: [company_id], onDelete: Cascade)      

  created       DateTime @default(now())
  updated       DateTime @updatedAt

  attached_leads crm_leads_contacts[]

}

model crm_interest {

  id                  String  @id @default(uuid()) @unique

  name                String
  description         String?
  color               String?

  created             DateTime @default(now())
  updated             DateTime @updatedAt

  leads crm_leads_interests[]

}

model crm_leads {

  id               String  @id @default(uuid()) @unique

  comment          String?
  origin           String?
  state            String?

  company_id       String
  company          crm_company @relation(references: [id], fields: [company_id], onDelete: Cascade)

  created          DateTime @default(now())
  updated          DateTime @updatedAt

  contacts crm_leads_contacts[]
  interests crm_leads_interests[]

}

model crm_leads_contacts {

  id               String  @id @default(uuid()) @unique

  lead_id          String
  lead             crm_leads @relation(references: [id], fields: [lead_id], onDelete: Cascade)

  contact_id       String
  contact          crm_company_contact @relation(references: [id], fields: [contact_id], onDelete: Cascade)

}

model crm_leads_interests {

  id              String   @id @default(uuid()) @unique

  order           Decimal? @default(0)

  interest_id     String
  interest        crm_interest @relation(references: [id], fields: [interest_id], onDelete: Cascade)

  lead_id         String
  lead            crm_leads @relation(references: [id], fields: [lead_id], onDelete: Cascade)

  created         DateTime @default(now())
  updated         DateTime @updatedAt

}

model pr_project {
  id                  String   @id @default(uuid()) @unique
  name                String?  @default("")

  created             DateTime @default(now())
  end_date            DateTime?
  start_date          DateTime?

  customer            String?
  closed              Boolean @default(false)

  assembly_buylists   scm_assembly_buylist[]
  order_rows          scm_order_rows[]
  
  attached_users      pr_project_attached_user[]

  fabrication_orders  scm_fabrication_order[]

}

model pr_project_attached_user {

  id                  String   @id @default(uuid()) @unique

  role                String?

  project_id          String
  project             pr_project @relation(references: [id], fields: [project_id], onDelete: Cascade)

  user_id             String
  user                User @relation(references: [id], fields: [user_id], onDelete: Cascade)

}